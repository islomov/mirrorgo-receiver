<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirrorGo Receiver 7</title>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        cast-media-player { --progress-color: #9333EA; --background-color: #000; }
        #status {
            position: fixed; top: 20px; left: 20px;
            color: #00FF00; font-family: monospace; font-size: 20px;
            z-index: 9999; background: rgba(0,0,0,0.9);
            padding: 15px 25px; border-radius: 8px; border: 2px solid #00FF00;
            max-width: 80%; word-wrap: break-word;
        }
        #status.error { color: #FF0000; border-color: #FF0000; }
    </style>
</head>
<body>
    <div id="status">MirrorGo: Init...</div>
    <cast-media-player></cast-media-player>

    <script>
        window.onerror = function(msg) { showError('JS: ' + msg); return false; };

        const statusEl = document.getElementById('status');
        function showStatus(msg) { console.log('Status: ' + msg); statusEl.textContent = 'MirrorGo: ' + msg; statusEl.className = ''; }
        function showError(msg) { console.error('Error: ' + msg); statusEl.textContent = 'ERROR: ' + msg; statusEl.className = 'error'; }

        try {
            const context = cast.framework.CastReceiverContext.getInstance();
            const playerManager = context.getPlayerManager();
            const playbackConfig = new cast.framework.PlaybackConfig();

            // Use Shaka for fMP4 HLS
            playbackConfig.useShakaForHls = true;
            playbackConfig.initialBandwidth = 2000000;

            // Minimal Shaka config - let it auto-detect most settings
            playbackConfig.shakaConfig = {
                streaming: {
                    useNativeHlsOnSafari: false,
                    bufferingGoal: 10,
                    rebufferingGoal: 2
                }
            };

            playerManager.addEventListener(cast.framework.events.EventType.ERROR, (e) => {
                const code = e.detailedErrorCode || 'none';
                const reason = e.error ? (e.error.shakaErrorCode || e.error.message || JSON.stringify(e.error)) : 'unknown';
                showError(code + ': ' + reason);
            });

            playerManager.addEventListener(cast.framework.events.EventType.PLAYER_LOADING, () => showStatus('Loading...'));
            playerManager.addEventListener(cast.framework.events.EventType.PLAYER_LOAD_COMPLETE, () => showStatus('Playing!'));
            playerManager.addEventListener(cast.framework.events.EventType.BUFFERING, (e) => showStatus(e.isBuffering ? 'Buffering...' : 'Playing'));

            playerManager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, (req) => {
                const url = req.media?.contentUrl || '?';
                showStatus('Load: ' + url.substring(0, 50));

                if (req.media) {
                    // Force fMP4 and LIVE stream type
                    req.media.hlsVideoSegmentFormat = cast.framework.messages.HlsVideoSegmentFormat.FMP4;
                    req.media.hlsSegmentFormat = cast.framework.messages.HlsSegmentFormat.FMP4;
                    req.media.streamType = cast.framework.messages.StreamType.LIVE;
                }
                return req;
            });

            const options = new cast.framework.CastReceiverOptions();
            options.disableIdleTimeout = true;
            options.playbackConfig = playbackConfig;
            options.useLegacyDashSupport = false;

            context.start(options);
            showStatus('Ready (Shaka)');

        } catch (e) { showError('Init: ' + e.message); }
    </script>
</body>
</html>
