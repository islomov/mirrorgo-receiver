<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MirrorGo Receiver 6</title>
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        cast-media-player { --progress-color: #9333EA; --background-color: #000; }
        #status {
            position: fixed; top: 20px; left: 20px;
            color: #00FF00; font-family: monospace; font-size: 20px;
            z-index: 9999; background: rgba(0,0,0,0.9);
            padding: 15px 25px; border-radius: 8px; border: 2px solid #00FF00;
            max-width: 80%; word-wrap: break-word;
        }
        #status.error { color: #FF0000; border-color: #FF0000; }
    </style>
</head>
<body>
    <div id="status">MirrorGo: Init...</div>
    <cast-media-player></cast-media-player>

    <script>
        window.onerror = function(msg) { showError('JS: ' + msg); return false; };

        const statusEl = document.getElementById('status');
        function showStatus(msg) { statusEl.textContent = 'MirrorGo: ' + msg; statusEl.className = ''; }
        function showError(msg) { statusEl.textContent = 'ERROR: ' + msg; statusEl.className = 'error'; }

        try {
            const context = cast.framework.CastReceiverContext.getInstance();
            const playerManager = context.getPlayerManager();
            const playbackConfig = new cast.framework.PlaybackConfig();

            // TRY WITHOUT SHAKA - use default MPL
            playbackConfig.useShakaForHls = false;
            playbackConfig.initialBandwidth = 2000000;

            playerManager.addEventListener(cast.framework.events.EventType.ERROR, (e) => {
                showError('Code ' + (e.detailedErrorCode || 'unknown'));
            });

            playerManager.addEventListener(cast.framework.events.EventType.PLAYER_LOADING, () => showStatus('Loading...'));
            playerManager.addEventListener(cast.framework.events.EventType.PLAYER_LOAD_COMPLETE, () => showStatus('Playing!'));
            playerManager.addEventListener(cast.framework.events.EventType.BUFFERING, (e) => showStatus(e.isBuffering ? 'Buffering...' : 'Playing'));

            playerManager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, (req) => {
                showStatus('Load: ' + (req.media?.contentUrl || '?').substring(0, 40));
                if (req.media) {
                    // Tell MPL this is fMP4 format
                    req.media.hlsVideoSegmentFormat = cast.framework.messages.HlsVideoSegmentFormat.FMP4;
                    req.media.hlsSegmentFormat = cast.framework.messages.HlsSegmentFormat.FMP4;
                }
                return req;
            });

            const options = new cast.framework.CastReceiverOptions();
            options.disableIdleTimeout = true;
            options.playbackConfig = playbackConfig;
            context.start(options);
            showStatus('Ready (MPL mode)');

        } catch (e) { showError('Init: ' + e.message); }
    </script>
</body>
</html>
